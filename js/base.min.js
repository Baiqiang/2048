function KeyboardInputManager(){this.events={},this.listen()}function LocalScoreManager(){this.key=(window.gameName||"")+"-bestScore";var a=this.localStorageSupported();this.storage=a?window.localStorage:window.fakeStorage}function Grid(a){this.size=a,this.cells=[],this.build()}function Tile(a,b,c){this.x=a.x,this.y=a.y,this.value=b||2,this.type=c||"number",this.previousPosition=null,this.mergedFrom=null}!function(){for(var a=0,b=["webkit","moz"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var d=(new Date).getTime(),e=Math.max(0,16-(d-a)),f=window.setTimeout(function(){b(d+e)},e);return a=d+e,f}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}(),KeyboardInputManager.prototype.on=function(a,b){this.events[a]||(this.events[a]=[]),this.events[a].push(b)},KeyboardInputManager.prototype.emit=function(a,b){var c=this.events[a];c&&c.forEach(function(a){a(b)})},KeyboardInputManager.prototype.listen=function(){var a=this,b={38:0,39:1,40:2,37:3,75:0,76:1,74:2,72:3,87:0,68:1,83:2,65:3};document.addEventListener("keydown",function(c){var d=c.altKey||c.ctrlKey||c.metaKey||c.shiftKey,e=b[c.which];d||(void 0!==e&&(c.preventDefault(),a.emit("move",e)),32===c.which&&a.restart.bind(a)(c))});var c=document.querySelector(".retry-button");c.addEventListener("click",this.restart.bind(this)),c.addEventListener("touchend",this.restart.bind(this));var d=document.querySelector(".keep-playing-button");d.addEventListener("click",this.keepPlaying.bind(this)),d.addEventListener("touchend",this.keepPlaying.bind(this));var e,f,g=document.querySelector(".outer-container")||document.querySelector(".game-container");g.addEventListener("touchstart",function(a){a.touches.length>1||(e=a.touches[0].clientX,f=a.touches[0].clientY,a.preventDefault())}),g.addEventListener("touchmove",function(a){a.preventDefault()}),g.addEventListener("touchend",function(b){if(!(b.touches.length>0)){var c=b.changedTouches[0].clientX-e,d=Math.abs(c),g=b.changedTouches[0].clientY-f,h=Math.abs(g);Math.max(d,h)>10&&a.emit("move",d>h?c>0?1:3:g>0?2:0)}})},KeyboardInputManager.prototype.restart=function(a){a.preventDefault(),this.emit("restart")},KeyboardInputManager.prototype.keepPlaying=function(a){a.preventDefault(),this.emit("keepPlaying")},window.fakeStorage={_data:{},setItem:function(a,b){return this._data[a]=String(b)},getItem:function(a){return this._data.hasOwnProperty(a)?this._data[a]:void 0},removeItem:function(a){return delete this._data[a]},clear:function(){return this._data={}}},LocalScoreManager.prototype.localStorageSupported=function(){var a="test",b=window.localStorage;try{return b.setItem(a,"1"),b.removeItem(a),!0}catch(c){return!1}},LocalScoreManager.prototype.get=function(){return this.storage.getItem(this.key)||0},LocalScoreManager.prototype.set=function(a){this.storage.setItem(this.key,a)},Grid.prototype.build=function(){for(var a=0;a<this.size;a++)for(var b=this.cells[a]=[],c=0;c<this.size;c++)b.push(null)},Grid.prototype.randomAvailableCell=function(){var a=this.availableCells();return a.length?a[Math.floor(Math.random()*a.length)]:void 0},Grid.prototype.availableCells=function(){var a=[];return this.eachCell(function(b,c,d){d||a.push({x:b,y:c})}),a},Grid.prototype.eachCell=function(a){for(var b=0;b<this.size;b++)for(var c=0;c<this.size;c++)a(b,c,this.cells[b][c])},Grid.prototype.cellsAvailable=function(){return!!this.availableCells().length},Grid.prototype.cellAvailable=function(a){return!this.cellOccupied(a)},Grid.prototype.cellOccupied=function(a){return!!this.cellContent(a)},Grid.prototype.cellContent=function(a){return this.withinBounds(a)?this.cells[a.x][a.y]:null},Grid.prototype.insertTile=function(a){this.cells[a.x][a.y]=a},Grid.prototype.removeTile=function(a){this.cells[a.x][a.y]=null},Grid.prototype.withinBounds=function(a){return a.x>=0&&a.x<this.size&&a.y>=0&&a.y<this.size},Tile.prototype.savePosition=function(){this.previousPosition={x:this.x,y:this.y}},Tile.prototype.updatePosition=function(a){this.x=a.x,this.y=a.y};